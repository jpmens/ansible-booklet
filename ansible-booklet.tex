% This file is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.
%
% This file is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.

% This file is very strongly copied with permission from the GRML-ZSH-Refcard
% project at https://github.com/grml/grml-gen-zshrefcard

\documentclass[10pt,             % 8pt
               a4paper,         % A4
               oneside,         % Einseitig
               DIV20,           % Papiergröße
             % DIV15,           % Größer
             % draft,           % Entwurf
               headsepline,     % Trennlinie oben
               footsepline,     % -""-       unten
               smallheadings,   % Kleine Überschriften
             % pointlessnumbers,% Keine Punkte
               halfparskip,     % Halbe Zeile Absatz statt Einzug
               nochapterprefix, % Kein "Kapitel"
             % bibtotoc         % "Literatur" im TOC  oder
             % bibtotocnumbered,% -""-, nummeriert
             % idxtotoc,        % Index im TOC
               twocolumn
              ]{scrartcl}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Pakete {{{
\usepackage[latin1]{inputenc}       % ISO-Umlaute
\usepackage[T1]{fontenc}            % T1-kodierte Fonts
%\usepackage{ae,aecompl}             % Kodierung für PDF
%\usepackage{ngerman}                % Deutsche Trennungen,
                                    % dt. Begriffe
\usepackage{setspace}               % Single- oder Onehalfspacing
%\setcounter{tocdepth}{4}            % 4 Hirarchien im Inhaltsv.
\usepackage{times}                  % Times als Schrift
%\usepackage{amsmath,amssymb,amstext}% Mathematische Symbole
\usepackage{url}                    % Darstellung von URLs
%\usepackage{calc}
\usepackage[iso,german]{isodate}
\usepackage{fancyvrb}

%%% Optional, je nach Dokument
% \usepackage{listings}             % Quelltext-Listings
% \usepackage{units}                % Technische Units
% \usepackage{psfrag}               % Ersetzts PS-Schriften
% \usepackage{color}                % Farben in LaTeX
% \usepackage{floatflt}             % Textumflossene Bilder...
% \usepackage{picins}               % Textumflossene Bilder
% \usepackage{textcomp}             % Spezielle Zeichen
% \usepackage[small,compact]{titlesec}             % Überschriften mit wenig Platz
% \usepackage{gensymb}              % Spezielle Zeichen
% \usepackage{eurosym}              % Euro-Symbol

%%% Layout
\usepackage{scrpage2}               % KOMA-Überschriften und -Fußzeilen.
%%% }}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage[pdftex]{graphicx}
\DeclareGraphicsExtensions{.pdf}
\pdfcompresslevel=9
\usepackage[%
  pdftex=true,
  backref=true,
  colorlinks=true,
  bookmarks=true,
  breaklinks=true,
  linktocpage=true,
  bookmarksopen=false,
  bookmarksnumbered=false,
  pdfpagemode=None
]{hyperref}
%%% }}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Eigene Funktionen {{{
%%% Beispiel:  \bild{200pt}{foo}{That's a foo\ldots}
\newcommand{\bild}[4]{
  \begin{figure}[ht]
    \includegraphics[width=#1, keepaspectratio=true]{#2}
    \caption{#3}
    \label{#4}
  \end{figure}
}

\newcommand{\kbd}[1]{\texttt{#1}}
\newcommand{\commandlistbegin}{
  \vspace{3pt}
  \begin{tabular}{ll}
}
\newcommand{\commandlistend}{
  \end{tabular}
}
\newcommand{\command}[2]{
  \texttt{#1} & \quad #2 \\
}
% JPM
\newcommand{\I}[1]{\textit{#1}}%
\newcommand{\B}[1]{\textbf{#1}}%
\newcommand{\C}[1]{\texttt{#1}}%
\usepackage{color}
\newcommand{\M}[1]{\color{green}{#1}\color{black}}%
\newcommand{\master}{\I{master}}%
\newcommand{\nodes}{\I{nodes}}%
\newcommand{\node}{\I{node}}%

\newcommand{\modulelistbegin}{
  \vspace{8pt}
  \begin{tabular}{l p{1.8cm} l}
}
\newcommand{\modulelistend}{
  \end{tabular}
  \vspace{8pt}
}
\newcommand{\module}[3]{
  #1 \quad & \C{\relsize{-1}#2} & \quad #3 \\
}
%% TEST
\newcommand{\man}{$\bullet$}
\newcommand{\opt}{$\circ$}

%%\newcommand{\modbeginhead}{
%%  \vspace{6pt}
%%  \begin{tabular}{p{4.3cm}p{6cm}}
%%}
%%\newcommand{\modendhead}{
%%  \end{tabular}
%%}
%%\newcommand{\modhead}[3]{
%%  % section name, url completer, description
%%  \C{\B{\relsize{+1}\href{http://ansible.github.com/modules.html\##2}{#1}}} & \relsize{-1}{#3} \\
%%}

%@@\usepackage{titlesec}
%@@\titleformat{\paragraph}[wrap]
%@@  {\normalfont\fontseries{b}\selectfont\filright}
%@@  {\thesection.}{.5em}{}
%@@\titlespacing{\paragraph}
%@@  {12pc}{1.5ex plus .1ex minus .2ex}{2pc}

\newcommand{\mods}[3]{% MODSECTION
  % section name, url completer, description
  % \paragraph{\C{\B{\relsize{+1}\href{http://ansible.github.com/modules.html\##2}{#1}}}} {#3}
  \subsubsection*{\C{\B{\relsize{+1}\href{http://ansible.github.com/modules.html\##2}{#1}}}}
  {#3}
}

\newenvironment{xlist}[1]
 {\begin{list}{}%
  {\renewcommand\makelabel[1]{{##1}\hfil}%
   \settowidth{\labelwidth}{#1}%
   \setlength{\labelsep}{0.5cm}%
   \setlength{\leftmargin}{\labelwidth}%
   \addtolength{\leftmargin}{\labelsep}%
   \setlength{\rightmargin}{0pt}%
   \setlength{\parsep}{0.5ex plus .2ex minus0.1ex}%
   \setlength{\itemsep}{0ex plus0.2ex}}}%
{\end{list}}

\DefineVerbatimEnvironment{code}{Verbatim}{fontsize=\small}
\usepackage{relsize}
\DefineVerbatimEnvironment{extymeta}{Verbatim}{fontfamily=courier,tabsize=0,xleftmargin=0.0cm,commandchars=\\\{\},fontsize=\relsize{-1}}

%% ENDJPM

%%% }}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Pagestyle {{{
  \pagestyle{scrheadings}
% \pagestyle{fancyhdrs}
% \pagestyle{empty}
%%% }}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Seitenkopf- und -Fußzeilen {{{
 \automark[subsection*]{section} % \left- und \rightmark bekommen Inhalt
%%% Oben: Links, Mitte, Rechts
 \ihead[]{{\Huge Ansible-Refcard}}
 \chead[]{}
 \ohead[]{\small\C{\{"pushed"\,:\,"\today{}"\}}}
%%% Unten: Links, Mitte, Rechts
 \ifoot[]{\vspace{-3pt}Ansible-Refcard}
 \cfoot[]{}
 \ofoot[]{\vspace{-3pt}\copyright 2012 \href{mailto:jpmens@gmail.com}{Jan-Piet Mens}}
%%% }}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Sonstiges {{{
% \setlength{\parindent}{17pt}      % Einzug 17pt,
% \setlength{\parskip}{2pt}         % keine Leerzeilen.

% \textwidth      127mm             % Textbreite
% \textheight     235mm             % Texthöhe
% \topmargin     -5mm               % Abstand oben
% \oddsidemargin  7mm               % Abstand Links, onepage

%\onehalfspacing                    % Zeilenabstand: Bei korrektur,
 \singlespacing                     % bei Abgabe

% Punkt- und Komma Abstände bei Tausendern/
% Dezimalzahlen ans deutsche anpassen!
 \mathcode`,="013B
 \mathcode`.="613A

 \setlength{\emergencystretch}{2em} % Notfallsstreckung
%%% }}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\addtolength{\voffset}{10pt}
%\renewcommand{\figurename}{Abb.}
\begin{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Titelseite {{{
%\pagenumbering{none}                % Für die Titelseite: Keine Seitennummern,
%\thispagestyle{empty}               % keine Kopf- und Fußzeilen.
%
%\begin{center}
%
%\end{center}
%\newpage
%
%%% }}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Inhaltsverzeichnis {{{
  \pagenumbering{arabic}            % Arabische Nummerierung
% \pagenumbering{roman}             % Kleine, römische Nummerierung
% \tableofcontents                  % Das Inhaltsverzeichnis
% \listoffigures                    % Verzeichnis aller Abbildungen
% \listoftables                     % Verzeichnis aller Tabellen
% \pagenumbering{arabic}            % ...und wieder Arabisch
% \newpage
%%% }}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% we won't be using math mode much, so redefine some of the characters
% we might want to talk about
\catcode`\^=12
\catcode`\_=12
%
\chardef\\=`\\
\chardef\{=`\{
\chardef\}=`\}

\parskip=0pt
\setlength{\tabcolsep}{0pt}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Inhalt {{{

%Schon in lhead
%\section{GRML's Zsh-Setup Reference Card}

\subsection*{Ansible}

Ansible, created by  Michael DeHaan, is a radically simple model-driven configuration management, deployment, and command execution framework. Other than Python 2.6 and a working SSH infrastructure, Ansible requires no setup, no daemons, no PKI, no nothing (Fig.~\ref{ansiblearchitecture}). 

\bild{250pt}{art/ansible.png}{Ansible architecture}{ansiblearchitecture}

\subsection*{Problems?}

If you need help or want to report a problem Ansible has a mailing-list
at \href{http://groups.google.com/group/ansible-project}{groups.google.com/group/ansible-project}. The latest and greatest code is on \href{https://github.com/ansible/ansible}{github.com/ansible/ansible}
where you can track issues and submit ideas. There are also lots of people
willing to assist on IRC: log in to \C{\#ansible} on FreeNode.

\subsection*{Getting started}

In this document we'll call the machine you run Ansible on (i.e. the machine from which you deploy) the \master{}; machines onto which you deploy (i.e. your clients), we'll call \nodes{}. On the \master{} you don't necessarily require \C{root} permission: Ansible can run as any user. Similarly, on \nodes{} you don't need root permissions either (well, maybe not): Ansible can connect to \nodes{} as a "normal" user and then (if required) \C{sudo} to root.

Download Ansible and unpack. You don't need to install it ... running from a git checkout is fine.
Create your \I{inventory} file and test: See the section on SSH for setting up SSH.

Ansible requires Python 2.6 though nodes only 2.4



\begin{small}
\begin{verbatim}
\end{verbatim}
\end{small}

\subsection*{Inventory}

\small{Ansible works against multiple systems in your infrastructure at the same time. It does this by selecting portions of systems listed in the inventory file, which defaults to \C{/etc/ansible/hosts}.}

\begin{extymeta}
localhost

[webs]
www.example.com
web[09-12].example.com
192.168.8.9

[devservers]
box1.example.com
jo.example.com \B{ntpserver=127.0.0.1}
\end{extymeta}

That last entry has what is called a \I{host var}; ignore that for now.


\subsection*{Modules}

Ansible ships with a number of modules (called the "module library") that can be executed directly on remote hosts or through Playbooks. Users can also write their own modules. These modules can control system resources, like services, packages, or files (anything really), or handle executing system commands. The following is a list of modules in the core library with supported options (\man{} is mandatory, \opt{} optional). (If you're viewing this in a PDF reader, click on the module name to go to the official module documentation at \href{http://ansible.github.com/}{ansible.github.com}.)

\begin{extymeta}
ansible 192.168.8.9 -m \B{ping}
ansible webs -m \B{copy} -a "src=/tmp/f dest=/etc/conf"
\end{extymeta}

%-----------------------------------------------------------------------

\input{modules}

%-----------------------------------------------------------------------

\subsection*{Playbooks}

Simply put, \href{http://ansible.github.com/playbooks.html}{Playbooks} are the basis for a really simple configuration management and multi-machine deployment system, unlike any that already exist, and one that is very well suited to deploying complex applications. Playbooks can declare configurations, but they can also orchestrate steps of any manual ordered process, even as different steps must bounce back and forth between sets of machines in particular orders. They can launch tasks synchronously or asynchronously. Playbooks are expressed in YAML format and have a minimum of syntax. Each playbook is composed of one or more \I{plays} in a list. Here's a playbook that contains just one play:

\begin{extymeta}
---
- hosts: devservers
  vars:
    http\_port: 80
    \B{conf}: httpd.j2
  user: root
  tasks:
  - name: ensure apache is at the latest version
    action: yum pkg=httpd state=latest
  - name: write the apache config file
    action: template src=/srv/\B{\$\{conf\}} dest=/etc/httpd.conf
    notify:
    - restart apache
  - name: ensure apache is running
    action: service name=httpd state=started
  handlers:
    - name: restart apache
      action: service name=apache state=restarted
\end{extymeta}

\begin{extymeta}
ansible-playbook -u jpm mini.yaml
\end{extymeta}

Use the \C{--verbose} flag for more information.


\begin{extymeta}
only_if: "not '${ansible_cmdline.BOOT_IMAGE}'.startswith('$')"
\end{extymeta}


\subsection*{Handlers \& Notification}

Modules are written to be \I{idempotent} and can relay when they have made a
change on the remote system. Playbooks recognize this and have a basic event
system that can be used to respond to change.  These \I{notify} actions are
triggered at the end of each \I{play} in a playbook, and trigger only once
each. For instance, multiple resources may indicate that apache needs to be
restarted, but apache will only be bounced once. Here's an example of
restarting two services when the contents of a file change, but only if the
file changes:

\begin{extymeta}
- name: template configuration file
  action: template src=template.j2 dest=/etc/foo.conf
  \B{notify}:
     - restart memcached
     - restart apache
\end{extymeta}

The things listed in the \I{notify} section of a task are called \I{handlers}. Handlers are lists of tasks, not really any different from regular tasks, that are referenced by name. Handlers are what notifiers notify. If nothing notifies a handler, it will not run. Regardless of how many things notify a handler, it will run only once, after all of the tasks complete in a particular play. Handlers are best used to restart services and trigger reboots. You probably won¿t need them for much else. Here¿s an example handlers section:

\begin{extymeta}
handlers:
    - name: restart memcached
      action: service name=memcached state=restarted
    - name: restart apache
      action: service name=apache state=restarted
\end{extymeta}

Notify handlers are always run in the order written.

\subsection*{Templates}

FIXME: short description of Jinja2 templates with one or two short examples using some vars from playbook and \M{setup}.

show:
	expansion
	if, else, endif
	switch / case ????
	loops


\subsection*{Delegation}

FIXME: what delegation is. mention localaction needs SSH to localhost

\subsection*{Facts}

refer to \M{setup}; maybe show short module example?


\bild{250pt}{art/ansible-facts-local.png}{That's a foo\ldots}{factslocal}

\subsection*{Variables}

\subsubsection*{Host vars}

\subsubsection*{Group vars}


\subsection*{SSH}

Paramiko is a native python implementation of the SSH protocol. It's
the default transport method used by Ansible, this method should work
for 99% of people by default. The native ssh transport method is
necessary in more complicated infrastructures where support for
bastion ('proxy') hosts is necessary, or if GSSAPI (kerberos) is used
for authentication. The native ssh transport will recognize your
\C{~/.ssh/config} file because it uses the 'ssh' command installed on the
local system.

[somegroup]
foo ansible_ssh_port=1234
bar ansible_ssh_port=1235

\subsection*{Shell variables used by Ansible}


You might want to stick to
just mentioning \$ANSIBLE_CONFIG and giving reference to
http://ansible.github.com/examples.html\#configuration-defaults


\begin{xlist}{ABCDEFGHIGJKLMNOP}

	\item[ANSIBLE\_SSH\_ARGS]

	\item[ANSIBLE\_REMOTE\_USER]

\end{xlist}

\subsection*{Extending Ansible}

\subsubsection*{Your own modules}

\subsubsection*{Callback plugins}

\subsection*{Tips and tricks: fun with Ansible}

\begin{enumerate}

    \item[1.]

	If your \I{nodes} have a version of Python which doesn't meet Ansible's
	requirements, install Python non-destructively in, say,
	\C{/usr/local/Python}, and configure your inventory to use that path on
	nodes (e.g. with a group variable).

	\begin{extymeta}
	ansible\_python\_interpreter: /usr/local/Python
	\end{extymeta}

    \item[2.]

    	Install \href{http://en.wikipedia.org/wiki/Cowsay}{Cowsay}. You must! (And make
	sure it's (symlinked) in \C{/usr/bin/cowsay}.)

	\begin{extymeta}
	 _____________________________ 
	< TASK: [Ansible says mooooo] >
	 ----------------------------- 
	        \\   ^__^
	         \\  (oo)\\_______
	            (__)\\       )\\/\\
	                ||----w |
	                ||     ||
	\end{extymeta}

    \item[3.]
    	Other "hidden" ansible variables FIXME

\end{enumerate}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Dieser Trenner muss eingefügt werden, wenn eine Tabelle zu lang ist
% und daher nicht von LaTeX umbrochen wird.
%\commandlistend
%
%\commandlistbegin
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%% }}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\end{document}

%%% vim:set ai tw=80 fdm=marker:   EOF
